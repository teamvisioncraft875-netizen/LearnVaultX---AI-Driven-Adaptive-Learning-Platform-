{% extends "base.html" %}

{% block title %}Reset Password - LearnVaultX{% endblock %}

{% block content %}
<div class="auth-page-container">
    <div class="auth-card" style="max-width: 520px; min-height: auto;">
        <div class="auth-form-panel" style="flex: 1; width: 100%; padding: 48px 40px;">
            <div class="auth-form-decoration"></div>
            <div class="auth-form-content" style="position: relative; z-index: 1;">
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üîë</div>
                    <h2 class="auth-form-title" style="margin-bottom: 8px;">Reset Password</h2>
                    <p class="auth-form-subtitle"
                        style="color: rgba(255,255,255,0.55); font-size: 14px; line-height: 1.5;">
                        Create a new password for your account.
                    </p>
                </div>

                <div id="alertBox"
                    style="display:none; padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; font-weight: 500;">
                </div>

                <form id="resetPasswordForm" onsubmit="return false;">
                    <div class="auth-form-group">
                        <label class="auth-form-label" for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="new_password" class="auth-form-input"
                            placeholder="Minimum 6 characters" required minlength="6" autofocus>
                    </div>

                    <div class="auth-form-group">
                        <label class="auth-form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirm_password" class="auth-form-input"
                            placeholder="Re-enter your password" required minlength="6">
                    </div>

                    <!-- Password strength indicator -->
                    <div id="strengthBar" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 4px; margin-bottom: 6px;">
                            <div id="s1"
                                style="flex:1; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.1);">
                            </div>
                            <div id="s2"
                                style="flex:1; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.1);">
                            </div>
                            <div id="s3"
                                style="flex:1; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.1);">
                            </div>
                            <div id="s4"
                                style="flex:1; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.1);">
                            </div>
                        </div>
                        <span id="strengthLabel" style="font-size: 12px; color: rgba(255,255,255,0.4);"></span>
                    </div>

                    <button type="submit" class="auth-submit-btn" id="resetBtn" onclick="resetPassword()">
                        <span id="btnText">Update Password</span>
                        <span id="btnSpinner" style="display:none;">Updating...</span>
                    </button>
                </form>

                <div class="auth-switch-text" style="text-align: center; margin-top: 24px;">
                    <a href="/login" class="auth-switch-link">‚Üê Back to Login</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Password strength indicator
    document.getElementById('newPassword').addEventListener('input', function () {
        const pw = this.value;
        let strength = 0;
        if (pw.length >= 6) strength++;
        if (pw.length >= 8) strength++;
        if (/[0-9]/.test(pw)) strength++;
        if (/[^a-zA-Z0-9]/.test(pw)) strength++;

        const colors = ['#ef4444', '#f59e0b', '#22c55e', '#10b981'];
        const labels = ['Weak', 'Fair', 'Good', 'Strong'];
        const bars = ['s1', 's2', 's3', 's4'];

        bars.forEach((id, i) => {
            document.getElementById(id).style.background = i < strength
                ? colors[Math.min(strength - 1, 3)]
                : 'rgba(255,255,255,0.1)';
        });

        const label = document.getElementById('strengthLabel');
        if (pw.length === 0) {
            label.textContent = '';
        } else {
            label.textContent = labels[Math.min(strength - 1, 3)] || 'Too short';
            label.style.color = strength > 0 ? colors[Math.min(strength - 1, 3)] : 'rgba(255,255,255,0.4)';
        }
    });

    async function resetPassword() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const btn = document.getElementById('resetBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');

        if (!newPassword || !confirmPassword) {
            showAlert('Please fill in both fields', 'error');
            return;
        }

        if (newPassword.length < 6) {
            showAlert('Password must be at least 6 characters', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            showAlert('Passwords do not match', 'error');
            return;
        }

        btn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';

        try {
            const res = await fetch('/api/forgot-password/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ new_password: newPassword, confirm_password: confirmPassword })
            });

            const data = await res.json();

            if (res.ok) {
                showAlert(data.message || 'Password updated! Redirecting to login...', 'success');
                setTimeout(() => { window.location.href = '/login'; }, 1500);
            } else {
                showAlert(data.message || data.error || 'Failed to reset password', 'error');
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
            }
        } catch (err) {
            showAlert('Network error. Please try again.', 'error');
            btn.disabled = false;
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
        }
    }

    function showAlert(msg, type) {
        const alertBox = document.getElementById('alertBox');
        alertBox.style.display = 'block';
        alertBox.textContent = msg;
        if (type === 'error') {
            alertBox.style.background = 'rgba(239, 68, 68, 0.15)';
            alertBox.style.color = '#fca5a5';
            alertBox.style.border = '1px solid rgba(239, 68, 68, 0.3)';
        } else {
            alertBox.style.background = 'rgba(34, 197, 94, 0.15)';
            alertBox.style.color = '#86efac';
            alertBox.style.border = '1px solid rgba(34, 197, 94, 0.3)';
        }
    }
</script>
{% endblock %}