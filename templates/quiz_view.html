{% extends "base.html" %}

{% block title %}Take Quiz - LearnVaultX{% endblock %}

{% block meta_robots %}noindex, nofollow{% endblock %}
{% block meta_description %}Take a quiz and get AI-powered feedback on your performance.{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; padding: var(--space-6) var(--space-4);">
    <!-- Quiz Header -->
    <div class="card" style="margin-bottom: var(--space-6);">
        <div
            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-4);">
            <div>
                <a href="javascript:history.back()" class="text-muted"
                    style="text-decoration: none; margin-bottom: var(--space-2); display: inline-block;">‚Üê Back to
                    Class</a>
                <h1 id="quiz-title" style="font-size: var(--text-2xl); color: var(--text-primary); margin: 0;">Loading
                    Quiz...</h1>
            </div>
            <div class="badge badge-primary" id="question-count">0 Questions</div>
        </div>
        <p id="quiz-description" style="color: var(--text-secondary);">Please wait while we load your quiz...</p>
    </div>

    <!-- Questions Container -->
    <div id="questions-container">
        <!-- Questions will be injected here -->
        <div style="text-align: center; padding: var(--space-8);">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Submit Section -->
    <div class="card" style="margin-top: var(--space-6); text-align: center;">
        <button id="submit-btn" class="btn btn-primary btn-lg" onclick="submitQuiz()" style="min-width: 200px;">
            Submit Quiz
        </button>
    </div>
</div>

<!-- Results Modal -->
<div id="results-modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Quiz Results</h2>
            <button class="btn btn-secondary btn-sm" onclick="closeResultsModal()">Close</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div
                style="font-size: 4rem; font-weight: bold; color: var(--primary-color); margin-bottom: var(--space-2);">
                <span id="score-display">0</span>%
            </div>
            <p id="score-details" style="color: var(--text-secondary); margin-bottom: var(--space-6);">You scored 0 out
                of 0</p>

            <!-- Adaptive Insights -->
            <div id="adaptive-insights"
                style="text-align: left; background: var(--bg-secondary); padding: var(--space-4); border-radius: var(--radius-md);">
                <h3 style="font-size: var(--text-lg); margin-bottom: var(--space-3);">ü§ñ AI Insights</h3>
                <div id="insights-content">
                    <p>Analyzing your performance...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.history.back()">Back to Class</button>
            <button class="btn btn-primary" onclick="window.location.href='/student/dashboard'">Go to Dashboard</button>
        </div>
    </div>
</div>

<script>
    const quizId = {{ quiz_id }};
    let quizData = null;
    let startTime = Date.now();
    let answers = {};

    document.addEventListener('DOMContentLoaded', loadQuiz);

    async function loadQuiz() {
        try {
            const response = await fetch(`/api/quiz/${quizId}`, {
                credentials: 'include'
            });

            const json = await response.json();

            if (!response.ok || !json.success) {
                console.error('Failed to load quiz', json);
                if (json && json.error) {
                    showToast(json.error, 'error');
                } else {
                    showToast('Failed to load quiz. Please try again.', 'error');
                }
                return;
            }

            quizData = json.data;
            renderQuiz(quizData);
        } catch (error) {
            console.error('Error:', error);
            showToast('Failed to load quiz. Please try again.', 'error');
        }
    }

    function renderQuiz(data) {
        document.getElementById('quiz-title').textContent = data.title;
        document.getElementById('quiz-description').textContent = data.description || 'No description provided.';
        document.getElementById('question-count').textContent = `${data.questions.length} Questions`;

        // Check for max attempts
        if (data.is_allowed === false) {
            document.getElementById('questions-container').innerHTML = `
                <div class="card" style="text-align: center; padding: var(--space-8); border-color: var(--accent-warning);">
                    <div style="font-size: 4rem; margin-bottom: var(--space-4);">‚ö†Ô∏è</div>
                    <h2 style="color: var(--text-primary); margin-bottom: var(--space-2);">Maximum Attempts Reached</h2>
                    <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">
                        You have used all ${data.max_attempts} attempts for this quiz.
                    </p>
                    <button class="btn btn-primary" onclick="window.history.back()">Back to Class</button>
                    <button class="btn btn-secondary" onclick="window.location.href='/student/dashboard'">Go to Dashboard</button>
                </div>
            `;
            document.getElementById('submit-btn').parentElement.style.display = 'none';
            return;
        }

        const container = document.getElementById('questions-container');
        container.innerHTML = data.questions.map((q, index) => `
            <div class="card" style="margin-bottom: var(--space-4);">
                <h3 style="font-size: var(--text-lg); margin-bottom: var(--space-4); display: flex; gap: var(--space-2);">
                    <span style="color: var(--text-secondary);">${index + 1}.</span>
                    <span>${escapeHtml(q.question_text)}</span>
                </h3>
                <div class="options-list" style="display: flex; flex-direction: column; gap: var(--space-2);">
                    ${q.options.map((opt, optIndex) => `
                        <label class="option-item" style="
                            display: flex; 
                            align-items: center; 
                            padding: var(--space-3); 
                            border: 1px solid var(--border-primary); 
                            border-radius: var(--radius-md); 
                            cursor: pointer; 
                            transition: all 0.2s;
                        " onmouseover="this.style.borderColor='var(--primary-color)'" onmouseout="if(!this.querySelector('input').checked) this.style.borderColor='var(--border-primary)'">
                            <input type="radio" name="q_${q.id}" value="${optIndex}" onchange="selectOption(${q.id}, ${optIndex})" style="margin-right: var(--space-3);">
                            <span>${escapeHtml(opt)}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function selectOption(questionId, optionIndex) {
        answers[questionId] = optionIndex;

        // Visual feedback
        const inputs = document.getElementsByName(`q_${questionId}`);
        inputs.forEach(input => {
            const label = input.closest('label');
            if (input.checked) {
                label.style.backgroundColor = 'var(--primary-light)';
                label.style.borderColor = 'var(--primary-color)';
            } else {
                label.style.backgroundColor = 'transparent';
                label.style.borderColor = 'var(--border-primary)';
            }
        });
    }

    let isSubmitting = false;

    async function submitQuiz() {
        console.log('=== SUBMIT QUIZ CALLED ===');

        // Prevent duplicate submissions
        if (isSubmitting) {
            console.log('Already submitting, ignoring...');
            return;
        }

        // Validate all questions answered
        if (Object.keys(answers).length < quizData.questions.length) {
            showToast('Please answer all questions before submitting', 'warning');
            return;
        }

        const submitBtn = document.getElementById('submit-btn');

        // Set submitting state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        isSubmitting = true;

        const duration = Math.floor((Date.now() - startTime) / 1000);

        console.log('Submitting quiz:', { quiz_id: quizId, answers, duration });

        try {
            // Submission timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.error('Request timed out after 20 seconds');
                controller.abort();
            }, 20000);

            const response = await fetch('/api/submit_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    quiz_id: quizId,
                    answers: answers,
                    duration: duration
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);

            // Get response text first for debugging
            const responseText = await response.text();
            console.log('Raw response text:', responseText.substring(0, 200));

            // Check if response is HTML (session expired / redirected to login)
            if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                console.error('Received HTML instead of JSON - session likely expired');
                showToast('Session expired. Please login again', 'error');
                // Redirect to login after 2 seconds
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            // Parse JSON
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('Parsed result:', result);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                throw new Error('Invalid response from server');
            }

            if (!result.success) {
                throw new Error(result.error || result.message || 'Submission failed');
            }

            // SUCCESS - Show toast
            if (typeof toast !== 'undefined' && toast.success) {
                toast.success('Quiz submitted successfully!');
            }

            // Show results modal
            showResults(result.data || result);
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitted';
            submitBtn.dataset.submitted = 'true';
            isSubmitting = false;
            return;

        } catch (error) {
            console.error('Submission error:', error);
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);

            if (error.name === 'AbortError') {
                showToast('Submission timed out. Please try again', 'error');
            } else {
                showToast('Failed to submit quiz: ' + error.message, 'error');
            }

        } finally {
            // Reset button only if not submitted
            if (submitBtn.dataset.submitted !== 'true') {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Quiz';
                isSubmitting = false;
            }
            console.log('=== BUTTON STATE RESET ===');
        }
    }

    function showResults(result) {
        console.log('=== SHOWING RESULTS ===', result);

        const modal = document.getElementById('results-modal');
        const submitBtn = document.getElementById('submit-btn');

        // Set score
        document.getElementById('score-display').textContent = result.percentage || 0;

        // Show attempt number if available
        const attemptText = result.attempt_number ? ` (Attempt #${result.attempt_number}/3)` : '';
        document.getElementById('score-details').textContent = `You scored ${result.score || 0} out of ${result.total || 0}${attemptText}`;

        // Display adaptive insights
        const insightsDiv = document.getElementById('insights-content');
        const insights = result.adaptive_insights || {};
        const percentage = result.percentage || 0;

        let html = '';

        // Performance feedback
        if (percentage >= 80) {
            html += '<div style="margin-bottom: var(--space-3); color: var(--accent-success);"><strong>‚úÖ Excellent work!</strong> You have a strong understanding of this material.</div>';
        } else if (percentage >= 60) {
            html += '<div style="margin-bottom: var(--space-3); color: var(--primary-color);"><strong>üëç Good job!</strong> Consider reviewing the topics you missed.</div>';
        } else {
            html += '<div style="margin-bottom: var(--space-3); color: var(--accent-warning);"><strong>üìö Keep practicing!</strong> Review the material and try again.</div>';
        }

        // Knowledge gaps
        if (insights.knowledge_gaps_detected > 0 && insights.gaps && insights.gaps.length > 0) {
            html += '<div style="margin-top: var(--space-4);"><strong>‚ö†Ô∏è Areas to Review:</strong><ul style="margin: var(--space-2) 0; padding-left: var(--space-4);">';
            insights.gaps.forEach(gap => {
                html += `<li>${gap.quiz || 'Topic'}: ${gap.question || 'Review needed'}</li>`;
            });
            html += '</ul></div>';
        }

        // Recommendations
        if (insights.recommendations_generated > 0 && insights.recommendations && insights.recommendations.length > 0) {
            html += '<div style="margin-top: var(--space-4);"><strong>üìö Recommended Next Steps:</strong><ul style="margin: var(--space-2) 0; padding-left: var(--space-4);">';
            insights.recommendations.forEach(rec => {
                html += `<li>${rec.reason || rec.title || rec}</li>`;
            });
            html += '</ul></div>';
        }

        // Max attempts warning and button logic
        if (result.is_limit_reached) {
            // Change close button to redirect
            const closeBtn = modal.querySelector('.btn-secondary[onclick="closeResultsModal()"]');
            if (closeBtn) {
                closeBtn.onclick = function () { window.location.href = '/student/dashboard'; };
                closeBtn.textContent = 'Back to Dashboard';
            }
            if (submitBtn) {
                submitBtn.textContent = 'Max Attempts Reached';
                submitBtn.disabled = true;
                submitBtn.dataset.submitted = 'true';
            }

            // Add warning message
            const warning = '<div style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--radius-md); color: #ef4444;"><strong>Please Note:</strong> You have used all 3 allowed attempts for this quiz. This is your final score.</div>';
            html = warning + html;
        }

        // Detailed Question Results
        if (result.question_results && result.question_results.length > 0) {
            html += '<div style="margin-top: var(--space-6); padding-top: var(--space-4); border-top: 1px solid var(--border-color);">';
            html += '<h4 style="margin-bottom: var(--space-4); color: var(--text-primary);">Detailed Results</h4>';

            // Attempt-gated messaging
            if (!result.show_answers) {
                html += `<div style="margin-bottom: var(--space-4); padding: var(--space-3); background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: var(--radius-md); color: #60a5fa;">
                    <strong>\uD83D\uDD12 Attempt ${result.attempt_number || '?'} of 3</strong> ‚Äî Correct answers and explanations will be revealed on your 3rd attempt.
                </div>`;
            }

            html += '<div style="display: flex; flex-direction: column; gap: var(--space-4); max-height: 300px; overflow-y: auto; padding-right: var(--space-2); text-align: left;">';

            result.question_results.forEach((q, index) => {
                const statusColor = q.is_correct ? 'var(--accent-success)' : 'var(--accent-warning)';
                const icon = q.is_correct ? '\u2705' : '\u274C';

                html += `
                    <div style="background: var(--bg-tertiary); padding: var(--space-3); border-radius: var(--radius-md); border-left: 4px solid ${statusColor};">
                        <div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--text-primary);">
                            <span style="margin-right: var(--space-2);">${index + 1}.</span> ${escapeHtml(q.question_text)}
                        </div>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                            <div style="margin-bottom: 4px;">Your Answer: <span style="color: ${q.is_correct ? 'var(--accent-success)' : 'var(--accent-warning)'}; font-weight: 500;">${escapeHtml(q.user_answer)} ${icon}</span></div>
                            ${(result.show_answers && !q.is_correct && q.correct_answer) ? `<div style="color: var(--text-muted);">Correct Answer: <span style="color: var(--accent-success); font-weight: 500;">${escapeHtml(q.correct_answer)}</span></div>` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
        }

        // Badges
        if (result.badges && result.badges.length > 0) {
            html += '<div style="margin-top: var(--space-6); text-align: center; animation: popIn 0.5s ease-out;">';
            html += '<h4 style="margin-bottom: var(--space-4); color: var(--accent-success);">üéâ New Badge Earned!</h4>';
            html += '<div style="display: flex; justify-content: center; gap: var(--space-4); flex-wrap: wrap;">';
            result.badges.forEach(badge => {
                html += `
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-success); padding: var(--space-4); border-radius: var(--radius-lg); width: 140px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: var(--space-2);">${badge.icon}</div>
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: var(--space-1);">${escapeHtml(badge.title)}</div>
                        <div style="font-size: var(--text-xs); color: var(--text-secondary);">${escapeHtml(badge.description)}</div>
                    </div>
                 `;
            });
            html += '</div></div>';
        }

        insightsDiv.innerHTML = html;

        // Render KyKnoX Mistake Notes (ONLY on attempt 3+ when show_answers is true)
        if (result.show_answers && result.mistake_notes && result.mistake_notes.length > 0) {
            let notesHtml = `
                <div style="margin-top: var(--space-6); padding-top: var(--space-4); border-top: 2px solid rgba(139, 92, 246, 0.3);">
                    <h3 style="font-size: var(--text-lg); margin-bottom: var(--space-4); color: #a78bfa; display: flex; align-items: center; gap: 8px;">
                        üìå KyKnoX Mistake Notes
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: var(--space-4); max-height: 400px; overflow-y: auto; padding-right: var(--space-2); text-align: left;">
            `;

            result.mistake_notes.forEach((note, index) => {
                notesHtml += `
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(96, 165, 250, 0.08)); 
                                border: 1px solid rgba(139, 92, 246, 0.2); 
                                border-radius: var(--radius-lg); 
                                padding: var(--space-4); 
                                position: relative;
                                overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, #8b5cf6, #60a5fa);"></div>
                        
                        <div style="padding-left: var(--space-3);">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2); font-size: var(--text-sm);">
                                ‚ùå Q: ${escapeHtml(note.question_text || '')}
                            </div>
                            
                            <div style="display: grid; gap: var(--space-2); font-size: var(--text-sm);">
                                <div style="display: flex; gap: 8px;">
                                    <span style="color: #ef4444; flex-shrink: 0;">‚úÖ</span>
                                    <div><strong style="color: #a78bfa;">Mistake:</strong> <span style="color: var(--text-secondary);">${escapeHtml(note.mistake_summary || '')}</span></div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <span style="color: #10b981; flex-shrink: 0;">üìå</span>
                                    <div><strong style="color: #10b981;">Quick Fix:</strong> <span style="color: var(--text-secondary);">${escapeHtml(note.quick_fix || '')}</span></div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <span style="color: #f59e0b; flex-shrink: 0;">üß†</span>
                                    <div><strong style="color: #f59e0b;">Memory Trick:</strong> <span style="color: var(--text-secondary);">${escapeHtml(note.memory_trick || '')}</span></div>
                                </div>
                                ${note.recommended_topic ? `
                                <div style="display: flex; gap: 8px;">
                                    <span style="color: #60a5fa; flex-shrink: 0;">üìö</span>
                                    <div><strong style="color: #60a5fa;">Review:</strong> <span style="color: var(--text-secondary);">${escapeHtml(note.recommended_topic)}</span></div>
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            notesHtml += `</div></div>`;
            insightsDiv.innerHTML += notesHtml;
        }

        // FORCE MODAL TO BE VISIBLE with inline styles
        modal.display = 'block'; // Fallback
        modal.style.display = 'flex';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.zIndex = '9999';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.classList.add('show');

        console.log('=== MODAL DISPLAYED ===');
    }

    function closeResultsModal() {
        const modal = document.getElementById('results-modal');
        modal.style.display = 'none';
        modal.classList.remove('show');

        // Reset button state
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Quiz';
        isSubmitting = false;

        console.log('=== MODAL CLOSED, STATE RESET ===');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}