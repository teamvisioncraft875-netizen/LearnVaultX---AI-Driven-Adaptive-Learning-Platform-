{% extends "base.html" %}

{% block title %}Class Analytics - LearnVaultX{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <h1 class="analytics-title">üìä Class Analytics</h1>
        <p class="analytics-subtitle">Monitor student performance and engagement</p>
    </div>

    <!-- Class Selector -->
    <div class="filters-container" style="margin-bottom: var(--space-6);">
        <div class="filter-group">
            <label class="filter-label">Select Class</label>
            <select class="filter-select" id="class-selector" style="min-width: 300px;">
                <option value="">Loading classes...</option>
            </select>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-label">Total Students</div>
            <div class="stat-value" id="total-students">--</div>
            <div class="stat-trend">
                <span>üìä</span>
                <span>Enrolled</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-label">Active Today</div>
            <div class="stat-value" id="active-today">--</div>
            <div class="stat-trend positive">
                <span>‚Üë</span>
                <span>Great engagement!</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-label">Avg Class Score</div>
            <div class="stat-value" id="avg-class-score">--</div>
            <div class="stat-trend positive">
                <span>üìà</span>
                <span>Improving</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-label">Completion Rate</div>
            <div class="stat-value" id="completion-rate">--</div>
            <div class="stat-trend positive">
                <span>‚úì</span>
                <span>On track</span>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
        <!-- Performance Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìä Performance Distribution</h3>
            </div>
            <div class="chart-container">
                <canvas id="performanceDistChart"></canvas>
            </div>
        </div>

        <!-- Completion Donut -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">‚úÖ Quiz Completion</h3>
            </div>
            <div class="chart-container">
                <canvas id="completionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìà Participation Trend (Last 7 Days)</h3>
            </div>
            <div class="chart-container">
                <canvas id="participationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Insights Row -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
        <!-- Most Difficult Quiz -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">‚ö†Ô∏è Most Challenging Quiz</h3>
            </div>
            <div id="difficult-quiz-info" style="padding: var(--space-4);">
                <div class="loading-skeleton" style="height: 100px;"></div>
            </div>
        </div>

        <!-- Most Failed Topic -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìö Topic Needing Attention</h3>
            </div>
            <div id="failed-topic-info" style="padding: var(--space-4);">
                <div class="loading-skeleton" style="height: 100px;"></div>
            </div>
        </div>
    </div>

    <!-- Top Students Leaderboard -->
    <div class="chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üèÜ Top Performing Students</h3>
            </div>
            <div class="leaderboard-container" id="leaderboard">
                <div class="loading-skeleton" style="height: 200px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    let perfChart, completionChart, participationChart;
    let currentClassId = null;

    // Load teacher analytics
    async function loadTeacherAnalytics() {
        try {
            const response = await fetch('/api/teacher/analytics');
            const data = await response.json();

            console.log('Teacher analytics data:', data);

            // Populate class selector
            const selector = document.getElementById('class-selector');
            selector.innerHTML = '<option value="">Select a class...</option>';

            data.class_analytics.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.class_id;
                option.textContent = cls.class_name;
                selector.appendChild(option);
            });

            // Auto-select first class
            if (data.class_analytics.length > 0) {
                currentClassId = data.class_analytics[0].class_id;
                selector.value = currentClassId;
                loadClassStats(currentClassId);
            }

        } catch (error) {
            console.error('Error loading teacher analytics:', error);
        }
    }

    async function loadClassStats(classId) {
        try {
            const response = await fetch(`/api/teacher/class-stats/${classId}`);
            const data = await response.json();

            console.log('Class stats:', data);

            // Update stats
            document.getElementById('total-students').textContent = data.total_students;
            document.getElementById('active-today').textContent = data.active_students_today;
            document.getElementById('avg-class-score').textContent = data.avg_class_score + '%';
            document.getElementById('completion-rate').textContent = data.quiz_completion_rate + '%';

            // Create performance distribution chart
            if (perfChart) perfChart.destroy();
            perfChart = createPerformanceDistributionChart('performanceDistChart', data.performance_distribution);

            // Create completion chart
            if (completionChart) completionChart.destroy();
            completionChart = createCompletionChart('completionChart',
                data.completion_stats.completed,
                data.completion_stats.pending
            );

            // Create participation trend chart
            if (participationChart) participationChart.destroy();
            participationChart = createParticipationTrendChart('participationChart', data.participation_trend);

            // Display difficult quiz info
            displayDifficultQuiz(data.most_difficult_quiz);

            // Display failed topic info
            displayFailedTopic(data.most_failed_topic);

            // Display leaderboard
            displayLeaderboard(data.top_students);

        } catch (error) {
            console.error('Error loading class stats:', error);
        }
    }

    function displayDifficultQuiz(quiz) {
        const container = document.getElementById('difficult-quiz-info');
        container.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: var(--space-2);">üìâ</div>
                <div style="font-size: var(--text-lg); font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);">
                    ${quiz.title}
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: var(--accent-warning); margin-bottom: var(--space-2);">
                    ${quiz.avg_score}%
                </div>
                <div style="color: var(--text-secondary); font-size: var(--text-sm);">
                    Average Score ‚Ä¢ ${quiz.attempts} attempts
                </div>
                <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md);">
                    <span style="color: var(--accent-warning);">üí° Consider reviewing this topic in class</span>
                </div>
            </div>
        `;
    }

    function displayFailedTopic(topic) {
        const container = document.getElementById('failed-topic-info');
        container.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: var(--space-2);">üìñ</div>
                <div style="font-size: var(--text-xl); font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-3);">
                    ${topic}
                </div>
                <div style="color: var(--text-secondary); margin-bottom: var(--space-3);">
                    Students are struggling with this topic
                </div>
                <div style="margin-top: var(--space-3); padding: var(--space-3); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md);">
                    <span style="color: var(--accent-danger);">‚ö†Ô∏è Intervention recommended</span>
                </div>
            </div>
        `;
    }

    function displayLeaderboard(students) {
        const container = document.getElementById('leaderboard');

        container.innerHTML = students.map(student => `
            <div class="leaderboard-item">
                <div class="leaderboard-rank ${student.rank === 1 ? 'top-1' : ''}">
                    ${student.rank}
                </div>
                <div class="leaderboard-info">
                    <div class="leaderboard-name">${student.name}</div>
                    <div class="leaderboard-stats">${student.quizzes_completed} quizzes completed</div>
                </div>
                <div class="leaderboard-score">${student.avg_score}%</div>
            </div>
        `).join('');
    }

    // Event listener for class selector
    document.getElementById('class-selector').addEventListener('change', (e) => {
        const classId = e.target.value;
        if (classId) {
            currentClassId = classId;
            loadClassStats(classId);
        }
    });

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadTeacherAnalytics);
</script>
{% endblock %}