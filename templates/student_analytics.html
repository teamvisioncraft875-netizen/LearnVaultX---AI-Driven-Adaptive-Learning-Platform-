{% extends "base.html" %}

{% block title %}My Analytics - LearnVaultX{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="analytics-header">
        <h1 class="analytics-title">üìä My Analytics</h1>
        <p class="analytics-subtitle">Track your learning progress and performance</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-label">Overall Progress</div>
            <div class="stat-value" id="overall-progress">--</div>
            <div class="stat-trend positive">
                <span>‚Üë</span>
                <span>Keep going!</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-label">Average Score</div>
            <div class="stat-value" id="avg-score">--</div>
            <div class="stat-trend positive">
                <span>‚Üë</span>
                <span>+5% this week</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-label">Quizzes Completed</div>
            <div class="stat-value" id="total-quizzes">--</div>
            <div class="stat-trend">
                <span>üìà</span>
                <span>Great progress!</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üéì</div>
            <div class="stat-label">Accuracy</div>
            <div class="stat-value" id="accuracy">--</div>
            <div class="stat-trend positive">
                <span>‚úì</span>
                <span>Excellent!</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
        <!-- Weekly Trend Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìà Weekly Performance Trend</h3>
            </div>
            <div class="chart-container large">
                <canvas id="weeklyTrendChart"></canvas>
            </div>
        </div>

        <!-- Progress Circle -->
        <div class="chart-card" style="display: flex; align-items: center; justify-content: center;">
            <div class="progress-circle">
                <svg width="200" height="200">
                    <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="progress-circle-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="progress-circle-fill" id="progressCircle" cx="100" cy="100" r="90"
                        stroke-dasharray="565.48" stroke-dashoffset="565.48"></circle>
                </svg>
                <div class="progress-circle-text">
                    <div class="progress-value" id="progress-value">0%</div>
                    <div class="progress-label">Overall Progress</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Breakdown -->
    <div class="chart-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìö Topic Performance Breakdown</h3>
            </div>
            <div class="chart-container">
                <canvas id="topicBreakdownChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Strong vs Weak Topics -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üí™ Strong Topics</h3>
            </div>
            <div id="strong-topics-list"></div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìñ Topics to Review</h3>
            </div>
            <div id="weak-topics-list"></div>
        </div>
    </div>

    <!-- Recent Quiz Attempts -->
    <div class="quiz-history-section">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üïí Recent Quiz Attempts</h3>
                <a href="/student/quiz-history" class="btn btn-secondary btn-sm">View All</a>
            </div>
            <div class="quiz-table-container">
                <table class="quiz-table">
                    <thead>
                        <tr>
                            <th>Quiz</th>
                            <th>Class</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                            <th>Date</th>
                            <th>Difficulty</th>
                        </tr>
                    </thead>
                    <tbody id="recent-attempts-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: var(--space-6);">
                                <div class="loading-skeleton" style="height: 40px;"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    let weeklyChart, topicChart;

    // Load analytics data
    async function loadAnalytics() {
        try {
            const response = await fetch('/api/student/analytics');
            const data = await response.json();

            console.log('Analytics data:', data);

            // Update stats
            document.getElementById('overall-progress').textContent = data.overall_progress + '%';
            document.getElementById('avg-score').textContent = data.avg_score + '%';
            document.getElementById('total-quizzes').textContent = data.total_quizzes;
            document.getElementById('accuracy').textContent = data.accuracy + '%';

            // Update progress circle
            updateProgressCircle(data.overall_progress);

            // Create weekly trend chart
            if (weeklyChart) weeklyChart.destroy();
            weeklyChart = createWeeklyTrendChart('weeklyTrendChart', data.weekly_trend);

            // Create topic breakdown chart
            if (topicChart) topicChart.destroy();
            topicChart = createTopicBreakdownChart('topicBreakdownChart', data.topic_breakdown);

            // Display strong topics
            displayTopics('strong-topics-list', data.strong_topics, true);

            // Display weak topics
            displayTopics('weak-topics-list', data.weak_topics, false);

            // Display recent attempts
            displayRecentAttempts(data.quiz_attempts.slice(0, 5));

        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function updateProgressCircle(progress) {
        const circle = document.getElementById('progressCircle');
        const valueEl = document.getElementById('progress-value');
        const circumference = 565.48;
        const offset = circumference - (progress / 100) * circumference;

        circle.style.strokeDashoffset = offset;
        valueEl.textContent = progress + '%';
    }

    function displayTopics(containerId, topics, isStrong) {
        const container = document.getElementById(containerId);
        const color = isStrong ? '#10b981' : '#f59e0b';

        container.innerHTML = topics.map(topic => `
            <div style="padding: var(--space-3); border-bottom: 1px solid rgba(96, 165, 250, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-primary);">${topic.topic}</span>
                    <span style="color: ${color}; font-weight: 600;">${topic.score}%</span>
                </div>
            </div>
        `).join('');
    }

    function displayRecentAttempts(attempts) {
        const tbody = document.getElementById('recent-attempts-tbody');

        tbody.innerHTML = attempts.map(attempt => {
            const scoreClass = attempt.score_percent >= 80 ? 'high' : attempt.score_percent >= 60 ? 'medium' : 'low';
            const accuracy = ((attempt.correct_answers / attempt.total_questions) * 100).toFixed(1);

            return `
                <tr>
                    <td>${attempt.quiz_title}</td>
                    <td>${attempt.class_name}</td>
                    <td>
                        <span class="score-badge ${scoreClass}">
                            ${attempt.score_percent}%
                        </span>
                    </td>
                    <td>${accuracy}%</td>
                    <td>${attempt.time_taken_minutes} min</td>
                    <td>${new Date(attempt.submitted_at).toLocaleDateString()}</td>
                    <td>
                        <span class="difficulty-badge ${attempt.difficulty.toLowerCase()}">
                            ${attempt.difficulty}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadAnalytics);
</script>
{% endblock %}